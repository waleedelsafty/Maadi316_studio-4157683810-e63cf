
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is the owner of a document
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Users can read and write their own profile
    match /users/{userId} {
      allow read, write: if isOwner(userId);
      // Deleting a user profile is not allowed
      allow delete: if false;
    }
    
    // Global settings can be read by any authenticated user, but only written by an admin (future)
    match /globalUnitTypes/{typeId} {
        allow read, write: if request.auth != null; // For now, any auth'd user can manage
    }
    
    // Global utility types can be read and written by any authenticated user
    match /globalUtilityTypes/{utilityTypeId} {
        allow read, write: if request.auth != null;
    }
    
    // Global payable categories can be read and written by any authenticated user
    match /globalPayableCategories/{categoryId} {
        allow read, write: if request.auth != null;
    }

    // Global payment methods can be read and written by any authenticated user
    match /globalPaymentMethods/{methodId} {
        allow read, write: if request.auth != null;
    }
    
    // Users can read and write their own notes
    match /users/{userId}/notes/{noteId} {
      allow read, write: if isOwner(userId);
    }

    // Buildings can be created by any authenticated user.
    // List operations are allowed ONLY if the query is filtered by ownerId.
    // Owners can read, update, and delete their own building documents.
    match /buildings/{buildingId} {
      allow list: if request.auth != null && request.query.where.ownerId == request.auth.uid;
      allow read, update, delete: if isOwner(get(/databases/$(database)/documents/buildings/$(buildingId)).data.ownerId);
      allow create: if request.auth != null;

      // Levels can be read and written by the owner of the parent building
      match /levels/{levelId} {
        allow read, write: if isOwner(get(/databases/$(database)/documents/buildings/$(buildingId)).data.ownerId);
      }
      
      // Units can be read and written by the owner of the parent building
      match /units/{unitId} {
        allow read, write: if isOwner(get(/databases/$(database)/documents/buildings/$(buildingId)).data.ownerId);
      }
      
      // Owners can be read and written by the owner of the parent building
      match /owners/{ownerId} {
        allow read, write: if isOwner(get(/databases/$(database)/documents/buildings/$(buildingId)).data.ownerId);
      }

      // Payments can be read and written by the owner of the parent building
      match /payments/{paymentId} {
        allow read, write: if isOwner(get(/databases/$(database)/documents/buildings/$(buildingId)).data.ownerId);
      }
      
      // Payables (expenses) can be read and written by the owner of the parent building
      match /payables/{payableId} {
        allow read, write: if isOwner(get(/databases/$(database)/documents/buildings/$(buildingId)).data.ownerId);
      }

      // Employees can be read and written by the owner of the parent building
      match /employees/{employeeId} {
        allow read, write: if isOwner(get(/databases/$(database)/documents/buildings/$(buildingId)).data.ownerId);
        
        // Salary History can be read and written by the owner of the parent building
        match /salaryHistory/{historyId} {
            allow read, write: if isOwner(get(/databases/$(database)/documents/buildings/$(buildingId)).data.ownerId);
        }
      }

      // Service Providers can be read and written by the owner of the parent building
      match /serviceProviders/{providerId} {
        allow read, write: if isOwner(get(/databases/$(database)/documents/buildings/$(buildingId)).data.ownerId);

        // Contract Payment History can be read and written by the owner of the parent building
        match /paymentHistory/{historyId} {
            allow read, write: if isOwner(get(/databases/$(database)/documents/buildings/$(buildingId)).data.ownerId);
        }
      }
    }
    
    // Test records can be read and written by any authenticated user
    match /testRecords/{recordId} {
      allow read, write: if request.auth != null;
    }
  }
}
